import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Container, Row, Col, Card, Form, Button, Alert as RBAlert, Spinner, Table } from 'react-bootstrap';
import api from '../services/api';
import { useAuth } from '../contexts/AuthContext';

function Donate() {
    const { user, isAuthenticated } = useAuth();
    const navigate = useNavigate();
    const [type, setType] = useState('Funds');
    const [amount, setAmount] = useState('');
    const [message, setMessage] = useState('');
    const [paymentMethod, setPaymentMethod] = useState('');
    const [cardNumber, setCardNumber] = useState('');
    const [cardExpiry, setCardExpiry] = useState('');
    const [cardCVC, setCardCVC] = useState('');
    const [upiId, setUpiId] = useState('');
    const [paypalEmail, setPaypalEmail] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');
    const [donations, setDonations] = useState([]);

    useEffect(() => {
        if (!isAuthenticated()) {
            navigate('/login', { state: { redirectTo: '/donate' } });
        }
    }, [isAuthenticated, navigate]);

    const fetchDonations = async () => {
        setLoading(true);
        setError('');
        try {
            const response = await api.get('/donations/my');
            setDonations(response.data);
        } catch {
            setError('Failed to fetch donations.');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (isAuthenticated()) {
            fetchDonations();
        }
    }, [isAuthenticated]);

    const validatePaymentDetails = () => {
        if (paymentMethod === 'Credit Card') {
            if (!cardNumber.match(/^\d{16}$/)) return 'Enter a valid 16-digit card number.';
            if (!cardExpiry.match(/^(0[1-9]|1[0-2])\/(\d{2})$/)) return 'Enter expiry as MM/YY.';
            if (!cardCVC.match(/^\d{3}$/)) return 'Enter a valid 3-digit CVC.';
        } else if (paymentMethod === 'UPI') {
            if (!upiId.match(/^\w+@\w+$/)) return 'Enter a valid UPI ID.';
        } else if (paymentMethod === 'PayPal') {
            if (!paypalEmail.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) return 'Enter a valid PayPal email.';
        }
        return '';
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        if (!type) {
            setError('Please select a donation type.');
            return;
        }
        if (type === 'Funds') {
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                setError('Please enter a valid donation amount.');
                return;
            }
            if (!paymentMethod) {
                setError('Please select a payment method.');
                return;
            }
            const paymentError = validatePaymentDetails();
            if (paymentError) {
                setError(paymentError);
                return;
            }
        }
        setLoading(true);
        try {
            let paymentReference = '';
            if (paymentMethod === 'Credit Card') {
                paymentReference = `Card:${cardNumber}|Exp:${cardExpiry}|CVC:${cardCVC}`;
            } else if (paymentMethod === 'UPI') {
                paymentReference = `UPI:${upiId}`;
            } else if (paymentMethod === 'PayPal') {
                paymentReference = `PayPal:${paypalEmail}`;
            }
            await api.post('/donations', {
                amount: type === 'Funds' ? parseFloat(amount) : 0,
                type,
                message,
                paymentMethod: type === 'Funds' ? paymentMethod : '',
                paymentReference,
            });
            setSuccess('Donation submitted successfully!');
            setAmount('');
            setType('Funds');
            setMessage('');
            setPaymentMethod('');
            setCardNumber('');
            setCardExpiry('');
            setCardCVC('');
            setUpiId('');
            setPaypalEmail('');
            fetchDonations();
        } catch {
            setError('Failed to submit donation.');
        } finally {
            setLoading(false);
        }
    };

    if (!isAuthenticated()) {
        return null;
    }

    return (
        <Container>
            <Row className="mb-4">
                <Col>
                    <h1 className="text-success">Make a Donation</h1>
                    <p className="text-muted">Support our cause by donating funds or supplies.</p>
                    <div className="mb-2">
                        <strong>User:</strong> {user?.firstName} {user?.lastName}
                    </div>
                </Col>
            </Row>
            <Row>
                <Col md={6}>
                    <Card className="shadow-sm mb-4">
                        <Card.Body>
                            <Form onSubmit={handleSubmit}>
                                <Form.Group className="mb-3">
                                    <Form.Label>Type</Form.Label>
                                    <Form.Select value={type} onChange={e => setType(e.target.value)} required>
                                        <option value="Funds">Funds</option>
                                        <option value="Supplies">Supplies</option>
                                        <option value="Other">Other</option>
                                    </Form.Select>
                                </Form.Group>
                                {type === 'Funds' && (
                                    <>
                                        <Form.Group className="mb-3">
                                            <Form.Label>Amount</Form.Label>
                                            <Form.Control type="number" min="1" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} required />
                                        </Form.Group>
                                        <Form.Group className="mb-3">
                                            <Form.Label>Payment Method</Form.Label>
                                            <Form.Select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} required>
                                                <option value="">Select Payment Method</option>
                                                <option value="Credit Card">Credit Card</option>
                                                <option value="UPI">UPI</option>
                                                <option value="PayPal">PayPal</option>
                                            </Form.Select>
                                        </Form.Group>
                                        {paymentMethod === 'Credit Card' && (
                                            <>
                                                <Form.Group className="mb-3">
                                                    <Form.Label>Card Number</Form.Label>
                                                    <Form.Control type="text" maxLength={16} value={cardNumber} onChange={e => setCardNumber(e.target.value.replace(/[^0-9]/g, ''))} required />
                                                </Form.Group>
                                                <Form.Group className="mb-3">
                                                    <Form.Label>Expiry (MM/YY)</Form.Label>
                                                    <Form.Control type="text" maxLength={5} value={cardExpiry} onChange={e => setCardExpiry(e.target.value)} required />
                                                </Form.Group>
                                                <Form.Group className="mb-3">
                                                    <Form.Label>CVC</Form.Label>
                                                    <Form.Control type="text" maxLength={3} value={cardCVC} onChange={e => setCardCVC(e.target.value.replace(/[^0-9]/g, ''))} required />
                                                </Form.Group>
                                            </>
                                        )}
                                        {paymentMethod === 'UPI' && (
                                            <Form.Group className="mb-3">
                                                <Form.Label>UPI ID</Form.Label>
                                                <Form.Control type="text" value={upiId} onChange={e => setUpiId(e.target.value)} required />
                                            </Form.Group>
                                        )}
                                        {paymentMethod === 'PayPal' && (
                                            <Form.Group className="mb-3">
                                                <Form.Label>PayPal Email</Form.Label>
                                                <Form.Control type="email" value={paypalEmail} onChange={e => setPaypalEmail(e.target.value)} required />
                                            </Form.Group>
                                        )}
                                    </>
                                )}
                                <Form.Group className="mb-3">
                                    <Form.Label>Message (optional)</Form.Label>
                                    <Form.Control as="textarea" rows={2} value={message} onChange={e => setMessage(e.target.value)} />
                                </Form.Group>
                                {error && <RBAlert variant="danger">{error}</RBAlert>}
                                {success && <RBAlert variant="success">{success}</RBAlert>}
                                <Button type="submit" variant="success" disabled={loading}>{loading ? <Spinner size="sm" /> : 'Donate'}</Button>
                            </Form>
                        </Card.Body>
                    </Card>
                </Col>
                <Col md={6}>
                    <Card className="shadow-sm mb-4">
                        <Card.Header>My Donations</Card.Header>
                        <Card.Body>
                            {loading ? <Spinner animation="border" /> : (
                                donations.length === 0 ? <div className="text-muted">No donations yet.</div> : (
                                    <Table responsive hover size="sm">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Amount</th>
                                                <th>Payment</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {donations.map(d => (
                                                <tr key={d.donationId}>
                                                    <td>{d.type}</td>
                                                    <td>{d.type === 'Funds' ? `$${d.amount.toFixed(2)}` : '-'}</td>
                                                    <td>{d.paymentMethod || '-'}</td>
                                                    <td>{d.status}</td>
                                                    <td>{new Date(d.createdDate).toLocaleString()}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </Table>
                                )
                            )}
                        </Card.Body>
                    </Card>
                </Col>
            </Row>
        </Container>
    );
}

export default Donate;
